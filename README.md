
![2](https://github.com/user-attachments/assets/5bd2ad6f-83cb-4955-bf99-3e84594290db)

# wrapper-manager-v1ç‰ˆ
ä¸€ä¸ªåŸºäº Web çš„è½»é‡çº§è¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œä¸“ä¸ºç®¡ç† `wrapper` äºŒè¿›åˆ¶ç¨‹åºè®¾è®¡ã€‚å®ƒæä¾›äº†ä¸€ä¸ªå¯è§†åŒ–çš„ä»ªè¡¨ç›˜ï¼Œæ”¯æŒå¤šè¿›ç¨‹å¹¶å‘ç®¡ç†ã€æ—¥å¿—å®æ—¶æŸ¥çœ‹ã€å¥åº·æ£€æŸ¥ä»¥åŠæ–­çº¿è‡ªåŠ¨é‡å¯ã€‚
## âœ¨ åŠŸèƒ½ç‰¹æ€§
* **Web å¯è§†åŒ–ç•Œé¢**ï¼šç›´è§‚çš„å¡ç‰‡å¼å¸ƒå±€ï¼Œå®æ—¶ç›‘æ§æ‰€æœ‰è¿›ç¨‹çŠ¶æ€ã€‚
* **å¤šè¿›ç¨‹ç®¡ç†**ï¼šæ”¯æŒæ·»åŠ ã€åœæ­¢ã€é‡å¯å¤šè´¦å·å¤šç«¯å£çš„ `wrapper` è¿›ç¨‹ã€‚
* **å®æ—¶æ—¥å¿—**ï¼šé€šè¿‡ WebSocket å®æ—¶æ¨é€è¿›ç¨‹è¾“å‡ºæ—¥å¿—ï¼ˆæ”¯æŒ PTY ä¼ªç»ˆç«¯ï¼‰ã€‚
* **å¥åº·æ£€æŸ¥**ï¼šè‡ªåŠ¨æ£€æµ‹æŒ‡å®šç«¯å£è¿é€šæ€§ï¼Œå¼‚å¸¸æ—¶è‡ªåŠ¨æ ‡è®°çŠ¶æ€å¹¶é‡å¯ã€‚
* **ç›‘æ§å…³é”®å­—**ï¼šç›‘æ§åˆ°æ—¥å¿—å‡ºç°å…³é”®å­—ï¼Œå¦‚ï¼š`KDCanProcessCKC` å°†é‡å¯è¿›ç¨‹ï¼Œå¯è‡ªè¡Œæ·»åŠ å¤šä¸ªå…¶ä»–å…³é”®å­—ã€‚
* **è‡ªåŠ¨é‡å¯**ï¼šè¿›ç¨‹æ„å¤–é€€å‡ºæˆ–å´©æºƒæ—¶è‡ªåŠ¨å°è¯•é‡å¯ã€‚
* **é…ç½®æŒä¹…åŒ–**ï¼šè‡ªåŠ¨ä¿å­˜è¿›ç¨‹åˆ—è¡¨ï¼Œé‡å¯ç®¡ç†å™¨åè‡ªåŠ¨å¯åŠ¨åˆ—è¡¨é‡Œçš„è¿›ç¨‹ã€‚
* **wrapperé¡¹ç›®**ï¼šhttps://github.com/zhaarey/wrapper  æˆ– https://github.com/WorldObservationLog/wrapper
* **apple-music-downloader åŸç‰ˆ**ï¼šhttps://github.com/zhaarey/apple-music-downloader
* **apple-music-downloader å¤šçº¿ç¨‹å¤šåŒºåŸŸç‰ˆæœ¬åˆ†æ”¯**ï¼šhttps://github.com/sky8282/apple-music-downloader

## ğŸ› ï¸ ç¯å¢ƒè¦æ±‚
* Linux (Debian/Ubuntu)
* Go 1.18+ (ä»…ç¼–è¯‘éœ€è¦)
* ç®¡ç†ç›®æ ‡ `wrapper` é¡¹ç›®

## ğŸš€ éƒ¨ç½²ä¸ä½¿ç”¨æŒ‡å—
### ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
```text
/root/wrapper/
â”œâ”€â”€ main.go           # æºç  (æˆ–è€…ç¼–è¯‘å¥½çš„ wrapper-manager)
â”œâ”€â”€ config.yaml       # wrapper-manager é…ç½®æ–‡ä»¶
â”œâ”€â”€ manager.json      # è¿›ç¨‹é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ è¿›ç¨‹ä¼šè‡ªåŠ¨ç”Ÿæˆ
â”œâ”€â”€ index.html        # å‰ç«¯ç•Œé¢
â”œâ”€â”€ wrapper           # wrapper äºŒè¿›åˆ¶ç¨‹åº
â””â”€â”€ rootfs            # wrapper ç›¸å…³çš„æ–‡ä»¶å¤¹
```
### åˆå§‹åŒ– Go æ¨¡å—ï¼š
```text
go mod init wrapper-manager
```
### ä¸‹è½½ä¾èµ– (WebSocket å’Œ PTY åº“)ï¼š
```text
go mod tidy
```
### ç¼–è¯‘ç¨‹åºï¼š
```text
go build -o wrapper-manager .
```
### èµ‹äºˆæ‰§è¡Œæƒé™ï¼š
```text
chmod +x wrapper-manager
```
### ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ç®¡ç†å™¨ï¼š
* è¯·æ ¹æ®è´¦å·åŒºåŸŸç­‰è¿›è¡Œä¿®æ”¹ config.yaml å‚æ•°å¹¶å¯åŠ¨ï¼š
```text
./wrapper-manager
```
### è´Ÿè½½å‡è¡¡çŠ¶æ€ä¸‹æ˜¾ç¤ºè§£å¯†é€Ÿåº¦éœ€å®‰è£… iproute2 ï¼š
```text
apt update
apt install -y iproute2
```
### åœ¨webç•Œé¢æ·»åŠ æ–°è¿›ç¨‹ï¼š
* ç‚¹å‡»ä»ªè¡¨ç›˜ä¸Šçš„ "+ æ·»åŠ æ–°è¿›ç¨‹" å¡ç‰‡ã€‚
* è¾“å…¥æˆ–é€‰æ‹©è´¦å·å¯¹åº”çš„åŒºåŸŸã€‚
* è¾“å…¥å®Œæ•´çš„å¯åŠ¨å‘½ä»¤ï¼Œå¦‚ï¼š`-H 127.0.0.1 -D 10020 -M 10021` æˆ– `-H 127.0.0.1 -D 10020 -M 10021 -L é‚®ç®±:å¯†ç ï¼Œæˆ– å…¶ä»–å¯åŠ¨å‚æ•°`ã€‚
* åœ¨æ—¥å¿—é‡ŒæŸ¥çœ‹å¹¶å‘é€ `2fa` éªŒè¯ç ã€‚
* æ³¨æ„ï¼šå‘½ä»¤ä¸­å¿…é¡»åŒ…å« -D <ç«¯å£> å‚æ•°ï¼Œç®¡ç†å™¨å°†ä½¿ç”¨è¯¥ç«¯å£ä½œä¸ºè¿›ç¨‹çš„å”¯ä¸€ ID è¿›è¡Œè¯†åˆ«å’Œå¥åº·æ£€æŸ¥ã€‚
* æ³¨æ„ï¼šè´Ÿè½½å‡è¡¡ä¸‹ m3u8 è·å–ä¸åˆ°ï¼Œéœ€è¦ä¸‹è½½æ»¡è¡€çš„ï¼Œè¯·åœ¨ä¸‹è½½å™¨ç›´æ¥å¡«å…¥å„ä¸ªè¿›ç¨‹çš„ è§£å¯†ç«¯å£ å’Œ m3u8ç«¯å£ã€‚
* ä»…ä¸ªäººç†è§£çš„è§£å¯†æµç¨‹ï¼š
```mermaid
flowchart TD
    A["Apple Music"] --> B["Content ID<br>(æ­Œæ›²ID)"]
    B --> C["ä» Apple æœåŠ¡å™¨è·å–:<br>Authorization Token (AT)<br>æœ‰æ•ˆæœŸé€šå¸¸å‡ å°æ—¶åˆ°1å¤©<br>ä¸”è§£å¯†æ›²ç›®åº”è¯¥ä¸º1000é¦–"]
    C --> D["KDProcessPersistentKeyWithAT<br>AT + Content ID<br>ç”Ÿæˆ Persistent Key<br>ç”¨äºç¦»çº¿æ’­æ”¾(è§£å¯†)"]

    D -->|"Persistent Key è§£å¯†æˆåŠŸ<br>è¿è¡Œæ­£å¸¸"| NormalPlay["Persistent Key è§£å¯†æˆåŠŸ<br>ç¦»çº¿æ’­æ”¾(è§£å¯†)è¿è¡Œæ­£å¸¸"]

    D -->|"æ’­æ”¾(è§£å¯†)å¤±è´¥<br>å‡ºç°ç±»ä¼¼çš„è­¦æŠ¥:"| F["å¯†é’¥æ— æ•ˆï¼ˆè¿‡æœŸ / AT å¤±æ•ˆï¼‰â–¼ç±»ä¼¼ä»¥ä¸‹æŠ¥è­¦â–¼<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>FairPlay error<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>Invalid CKC error<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>Persistent Key Error<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>ç­‰ç­‰..."]

    F --> G["è‡ªåŠ¨åˆ·æ–° AT<br>ç½‘ç»œä¸ç¨³ç­‰å¯èƒ½åŒæ—¶è§¦å‘<br>KDCanProcessCKC æŠ¥è­¦"]

    G --> H["ä½¿ç”¨æ–° AT é‡æ–°è°ƒç”¨<br>KDProcessPersistentKeyWithAT<br>ç”Ÿæˆæ–°çš„ Persistent Key"]

    H --> NormalPlay

    style A fill:#2c2c2c,stroke:#007AFF,color:#fff
    style B fill:#1c1c1e,stroke:#007AFF,color:#fff
    style C fill:#1c1c1e,stroke:#007AFF,color:#fff
    style D fill:#1c1c1e,stroke:#007AFF,color:#fff
    style NormalPlay fill:#007AFF,stroke:#007AFF,color:#fff
    style F fill:#8B0000,stroke:#FF3B30,color:#fff
    style G fill:#1c1c1e,stroke:#FF3B30,color:#fff
    style H fill:#1c1c1e,stroke:#FF9F0A,color:#fff
